# Chatting Server with Java21

## π― **κΈ°λ¥ λ©λ΅**

**/name**

- ν΄λΌμ΄μ–ΈνΈκ°€ μ²μ μ—°κ²°λλ©΄ μ„λ²„λ” μ΄ ν΄λΌμ΄μ–ΈνΈμ—κ² `(127.0.0.1, 9001)` μ²λΌ ν΄λΌμ΄μ–ΈνΈ μΈ΅ IP μ£Όμ†μ™€ port λ²νΈλ¥Ό μ΄λ¦„μΌλ΅ λ¶€μ—¬ ν•©λ‹λ‹¤.
- `/name` λ…λ Ήμ€ μ—°κ²°ν• ν΄λΌμ΄μ–ΈνΈμ λ‹‰λ„¤μ„μ„ λ³€κ²½ν•©λ‹λ‹¤.
- ν•΄λ‹Ή ν΄λΌμ΄μ–ΈνΈμ—κ²λ” μ‹μ¤ν… λ©”μ‹μ§€λ΅ `[μ‹μ¤ν… λ©”μ‹μ§€] μ΄λ¦„μ΄ test μΌλ΅ λ³€κ²½λμ—μµλ‹λ‹¤.` μ™€ κ°™μ€ μ•λ¦Όμ΄ κ°€μ•Όλ©λ‹λ‹¤.
- λ§μΌ μ΄ ν΄λΌμ΄μ–ΈνΈκ°€ λ€ν™”λ°©μ— λ“¤μ–΄κ°€ μλ” κ²½μ°, λ€ν™”λ°©μ— μλ” λ¨λ“  λ©¤λ²„λ“¤μ—κ² `[μ‹μ¤ν… λ©”μ‹μ§€] μ΄λ¦„μ΄ test μΌλ΅ λ³€κ²½λμ—μµλ‹λ‹¤.` μ™€ κ°™μ€ λ©”μ‹μ§€κ°€ μ¶”κ°€λ΅ κ°€μ•Όλ©λ‹λ‹¤.

**/rooms**

- ν„μ¬ κ°μ„¤λ λ€ν™”λ°© λ©λ΅μ΄ μ¶λ ¥λ©λ‹λ‹¤.
- λ€ν™”λ°© λ©λ΅μ€ (1) λ°© λ²νΈ, (2) λ°© μ λ©, (3) μ°Έμ—¬μ¤‘μΈ λ©¤λ²„λ“¤μ μ΄λ¦„ μ΄ λ‚μ—΄λμ–΄μ•Ό λ©λ‹λ‹¤.
- μ„ μ •λ³΄κ°€ ν¬ν•¨λλ”ν• μ¶λ ¥ ν•μ‹μ€ μμ λ΅­κ² ν•λ©΄ λ©λ‹λ‹¤.
- κ°μ„¤λ λ€ν™”λ°©μ΄ μ—†λ” κ²½μ° μ΄λ¥Ό μ•μ•„λ³Ό μ μκ² μμ λ΅­κ² ν‘μ‹ν•λ©΄ λ©λ‹λ‹¤.

**/create**

- λ€ν™”λ°©μ„ κ°μ„¤ν•λ” λ…λ Ήμ–΄λ΅μ„, λ’¤μ— λ°©μ λ©μ„ μ…λ ¥ν•΄μ•Ό λ©λ‹λ‹¤. μμ‹: `/create hello world`
- λ€ν™”λ°© κ°μ„¤μ€ ν„μ¬ μ°Έμ—¬ μ¤‘μΈ λ€ν™”λ°©μ΄ μ—†λ” κ²½μ°λ§ κ°€λ¥ν•΄μ•Όλ©λ‹λ‹¤. λ§μΌ ν„μ¬ λ‹¤λ¥Έ λ°©μ— λ“¤μ–΄κ°€ μλ” κ²½μ° μ„λ²„λ” `[μ‹μ¤ν… λ©”μ‹μ§€] λ€ν™” λ°©μ— μμ„ λ•λ” λ°©μ„ κ°μ„¤ ν•  μ μ—†μµλ‹λ‹¤.` λ©”μ‹μ§€λ¥Ό ν•΄λ‹Ή μ μ €μ—κ² μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.
- λ€ν™”λ°© κ°μ„¤κ³Ό λ™μ‹μ— ν•΄λ‹Ή μ μ €λ” κ·Έ λ°©μ— μλ™μΌλ΅ μ…μ¥ν•κ² λ©λ‹λ‹¤. μμ‹:

    ```
    /create hello world
    [μ‹μ¤ν… λ©”μ‹μ§€] λ°©μ [hello world] λ°©μ— μ…μ¥ν–μµλ‹λ‹¤.
    ```


**/join**

- μ΄λ―Έ κ°μ„¤λ λ°©μ— μ°Έμ—¬ν•  μ μλ” λ…λ Ήμ–΄λ΅μ„, λ’¤μ— λ°© λ²νΈλ¥Ό μ…λ ¥ν•΄μ•Ό λ©λ‹λ‹¤. μμ‹: `/join 2`
- λ€ν™”λ°© μ°Έμ—¬λ” ν„μ¬ μ°Έμ—¬μ¤‘μΈ λ€ν™”λ°©μ΄ μ—†λ” κ²½μ°λ§ κ°€λ¥ν•΄μ•Ό λ©λ‹λ‹¤. λ§μΌ ν„μ¬ λ‹¤λ¥Έ λ°©μ— λ“¤μ–΄κ°€ μλ” κ²½μ° μ„λ²„λ” `[μ‹μ¤ν… λ©”μ‹μ§€] λ€ν™” λ°©μ— μμ„ λ•λ” λ‹¤λ¥Έ λ°©μ— λ“¤μ–΄κ° μ μ—†μµλ‹λ‹¤.` λ©”μ‹μ§€λ¥Ό ν•΄λ‹Ή μ μ €μ—κ² μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.
- μ—†λ” λ°© λ²νΈμ λ°©μΌλ΅ λ“¤μ–΄κ°€λ ¤κ³  ν•  λ• μ„λ²„λ” `[μ‹μ¤ν… λ©”μ‹μ§€] λ€ν™”λ°©μ΄ μ΅΄μ¬ν•μ§€ μ•μµλ‹λ‹¤.` λ©”μ‹μ§€λ¥Ό ν•΄λ‹Ή μ μ €μ—κ² μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.
- λ°©μ— λ“¤μ–΄κ°€λ©΄ μ„λ²„λ” ν•΄λ‹Ή μ μ €μ—κ² `[μ‹μ¤ν… λ©”μ‹μ§€] λ°©μ [hello world] λ°©μ— μ…μ¥ν–μµλ‹λ‹¤.` μ™€ κ°™μ€ λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.
- λ°©μ— λ“¤μ–΄κ°„ κ²½μ° λ¨λ“  κΈ°μ΅΄ λ©¤λ²„λ“¤μ—κ²λ” `[μ‹μ¤ν… λ©”μ‹μ§€] [test2] λ‹μ΄ μ…μ¥ν–μµλ‹λ‹¤.` μ™€ κ°™μ€ λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.

**/leave**

- λ€ν™”λ°©μ„ λ‚κ°€λ” λ…λ Ήμ–΄μ…λ‹λ‹¤.
- λ€ν™”λ°©μ— μ°Έμ—¬ μ¤‘μ΄μ§€ μ•μ„ λ• μ„λ²„λ” `[μ‹μ¤ν… λ©”μ‹μ§€] ν„μ¬ λ€ν™”λ°©μ— λ“¤μ–΄κ°€ μμ§€ μ•μµλ‹λ‹¤.` λ©”μ‹μ§€λ¥Ό ν•΄λ‹Ή μ μ €μ—κ² μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.
- λ‚¨μ•„μλ” λ©¤λ²„λ“¤μ—κ²λ” `[μ‹μ¤ν… λ©”μ‹μ§€] [test2] λ‹μ΄ ν‡΄μ¥ν–μµλ‹λ‹¤.` μ™€ κ°™μ€ λ©”μ‹μ§€κ°€ μ „μ†΅ λμ–΄μ•Ό λ©λ‹λ‹¤.
- λ‚κ°„ μ μ € λ³ΈμΈμ—κ²λ” `[μ‹μ¤ν… λ©”μ‹μ§€] λ°©μ [hello world] λ€ν™” λ°©μ—μ„ ν‡΄μ¥ν–μµλ‹λ‹¤.` μ™€ κ°™μ€ λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.

**/shutdown**

- μ±„ν… μ„λ²„λ¥Ό μΆ…λ£ν•λ” λ…λ Ήμ–΄μ…λ‹λ‹¤.
- μ„λ²„λ” μ΄ λ…λ Ήμ–΄λ¥Ό μμ‹ ν•λ©΄ μƒμ„±ν• μ“°λ λ“λ“¤μ„ μ •λ¦¬ν•κ³  ν”„λ΅κ·Έλ¨μ„ μΆ…λ£ν•΄μ•Ό λ©λ‹λ‹¤.

**κ·Έλ°–μ— μ…λ ¥**

`/` λ΅ μ‹μ‘ν•μ§€ μ•λ” λ¬Έμμ—΄μ€ μ±„ν… λ©”μ‹μ§€λ΅ μΈμ‹ν•©λ‹λ‹¤.

- λ§μΌ λ€ν™” λ°©μ— μ—†λ” κ²½μ° μ„λ²„λ” `[μ‹μ¤ν… λ©”μ‹μ§€] ν„μ¬ λ€ν™”λ°©μ— λ“¤μ–΄κ°€ μμ§€ μ•μµλ‹λ‹¤.` λ¥Ό ν•΄λ‹Ή μ μ €μ—κ² μ „μ†΅ν•΄μ•Ό λ©λ‹λ‹¤.
- λ§μΌ λ€ν™” λ°©μ— μλ” κ²½μ° ν•΄λ‹Ή μ±„ν… λ©”μ‹μ§€λ” λ³ΈμΈμ„ μ μ™Έν• λ‚λ¨Έμ§€ λ¨λ“  λ©¤λ²„λ“¤μ—κ² μ „μ†΅λμ–΄μ•Ό ν•©λ‹λ‹¤.

## π“© ν΄λΌμ΄μ–ΈνΈ-μ„λ²„κ°„ λ©”μ‹μ§€

JSON κ³Ό Protobuf λ‘ κ²½μ°λ¥Ό λ¨λ‘ κµ¬ν„ν•λ” κ²ƒμ΄ λ©μ μ…λ‹λ‹¤. μ•„λ μ„¤λ…μ—μ„ `CS` κ°€ λ¶™λ” λ©”μ‹μ§€ ν¬λ§·μ€ `ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„` λ¥Ό μλ―Έν•©λ‹λ‹¤. `SC` λ” `μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ` λ¥Ό μλ―Έν•©λ‹λ‹¤.

**JSON μ„ μ΄μ©ν•λ” κ²½μ°**

- **ν΄λΌμ΄μ–ΈνΈ -> μ„λ²„ λ©”μ‹μ§€**: client.py μ `on_cs_name()`, `on_cs_rooms()`, `on_cs_create()`, `on_cs_join()`, `on_cs_leave()`, `on_cs_chat()` ν•¨μλ“¤μ„ λ³΄λ©΄ κ° λ…λ Ήμ–΄μ— λ€ν•΄μ„ μ„λ²„ μ „μ†΅μ‹ JSON λ©”μ‹μ§€ ν¬λ§·μ„ μ• μ μμµλ‹λ‹¤. μ΄λ¥Ό μ°Έκ³ ν•κΈΈ λ°”λλ‹λ‹¤.
- **μ„λ²„ -> ν΄λΌμ΄μ–ΈνΈ λ©”μ‹μ§€**: `/rooms` λ…λ Ήμ–΄μ— λ€ν• μ‘λ‹µμ€ `on_sc_rooms_result()` ν•¨μλ¥Ό μ°Έκ³ ν•κΈΈ λ°”λλ‹λ‹¤. λ‹¤λ¥Έ μ μ €κ°€ μ…λ ¥ν• μ±„ν… λ©”μ‹μ§€λ¥Ό λ°›λ” κ²½μ°λ” `on_sc_chat()` ν•¨μλ¥Ό μ°Έκ³  λ°”λλ‹λ‹¤. κ·Έ μ™Έμ— `/` λ΅ μ‹μ‘ν•λ” λ…λ Ήμ–΄λ“¤μ— λ€ν• μ²λ¦¬λ” λ¨λ‘ `on_sc_system_message()` μ— μν•΄μ„ μ²λ¦¬ λ©λ‹λ‹¤.

**Protobuf λ¥Ό μ΄μ©ν•λ” κ²½μ°**

λ©”μ‹μ§€ ν•νƒλ” `message.proto` νμΌμ— μ •μλμ–΄ μμµλ‹λ‹¤. μ΄λ¥Ό μ‚¬μ©ν•κΈ° μ„ν•΄μ„λ” λ‹¤μκ³Ό κ°™μ€ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•΄μ„ message.proto νμΌμ λ‚΄μ©μ„ ν¬ν•¨ν•λ” python module μ„ μƒμ„±ν•΄μ•Ό λ©λ‹λ‹¤. (λ³Έ repo μ— μ΄λ―Έ ν¬ν•¨ν•κ³  μμ§€λ§, λ§μΌ μμ •μ„ ν•λ” κ²½μ° μ•„λ λ…λ Ήμ–΄λ¥Ό λ‹¤μ‹ μ‹¤ν–‰ν•΄μ•Ό λ©λ‹λ‹¤.)

```
$ protoc --python_out=. -I. message.proto
```

JSON μ κ²½μ°μ™€ λ§μ°¬κ°€μ§€λ΅ λ€μ‘λλ” `on_cs_XXX()` ν•¨μμ™€ `on_sc_YYY()` ν•¨μλ¥Ό μ°Έκ³ ν•΄μ„ λ©”μ‹μ§€λ¥Ό λ§λ“¤λ©΄ λ©λ‹λ‹¤.

## β… **κµ¬ν„ μ”κµ¬ μ΅°κ±΄**

- μ•μ client.py λ…λ Ήμ–΄λ“¤μ΄ λ™μ‘ν•κ²λ” λ©”μ‹μ§€ ν¬λ§· (= ν”„λ΅ν† μ½)μ΄ νΈν™λλ” μ„λ²„λ¥Ό μ‘μ„±ν•μ‹μ¤.
- μ„λ²„λ” **Python, C++, Java μ–΄λ–¤ κ²ƒμ„ μ¨λ„ μƒκ΄€ μ—†μ§€λ§, framework μ€ μ‚¬μ©ν•  μ μ—†μΌλ©° μ§μ ‘ I/O multiplexing κ³Ό producer-consumer λ¬Έμ λ¥Ό κµ¬ν„ν•΄μ•Ό ν•¨**
- μ„λ²„λ” worker thread λ“¤μ κ°μλ¥Ό μμ •ν•  μ μμ–΄μ•Ό ν•©λ‹λ‹¤. (ν”„λ΅κ·Έλ¨ μ‹¤ν–‰ μΈμλ΅ ν•  μ μλ‹¤λ©΄ κ°€μ¥ μΆ‹κ² μ§€λ§, μ΄ λ¶€λ¶„μ΄ μµμ™μΉ μ•λ‹¤λ©΄ μ½”λ“ μƒμ—μ„ λ€μ‘λλ” λ³€μ κ°’μ„ κ³ μΉλ©΄ μ“°λ λ“ κ°μκ°€ μμ •λκ² κµ¬ν„ν•΄μ•Ό λ©λ‹λ‹¤.)
- μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ— λ©”μ‹μ§€λ¥Ό μ „μ†΅ν•κ³  κ·Έκ² ν΄λΌμ΄μ–ΈνΈμ—μ„ μ¶λ ¥λλ” κ²ƒμ΄ μ¤‘μ”ν•©λ‹λ‹¤. μƒν” μ„λ²„λ¥Ό ν‰λ‚΄λ‚Έλ‹¤λ©΄ μ΄ λ¶€λ¶„μ„ ν‰λ‚΄λ‚΄κ³ , μ„λ²„ μμ²΄μ—μ„ μ¶λ ¥λλ” μ‹¤ν–‰ λ΅κ·Έ λ©”μ‹μ§€λ” λ‘κ°™μ„ ν•„μ”κ°€ μ—†μµλ‹λ‹¤.

## β… **ν‰κ°€ ν•­λ©**

- [ ]  worker thread λ¥Ό 2κ° μ΄μƒμΌλ΅ μ§€μ •ν•  μ μλ„λ΅ ν”„λ΅κ·Έλλ°ν–λ”μ§€ μ—¬λ¶€
- [ ]  worker thread κ°€ 2κ° μ΄μƒμΌ λ• μ„μ λ…λ Ήμ–΄λ“¤μ΄ μ λ€λ΅ λ™μ‘ν•λ”μ§€ μ—¬λ¶€ (= synchronization μ΄ μ λ€λ΅ κµ¬ν„λμ—λ”μ§€)
- [ ]  λ‘ μ΄μƒμ μ±„ν… λ°©μ— μ μ €λ“¤μ΄ λ‚λ  λ“¤μ–΄κ°€ μλ” κ²½μ° λ€ν™”λ°© κ°„ κ°„μ„­ μ—†μ΄ μ λ€λ΅ μ±„ν…μ΄ λλ”μ§€ μ—¬λ¶€
- [ ]  I/O multiplexing μ μ© μ—¬λ¶€
- [ ]  producer-consumer μ μ© μ—¬λ¶€ (= queue, mutex, condition variable μ‚¬μ© μ—¬λ¶€)
- [ ]  Message handler map μ μ© μ—¬λ¶€
- [ ]  JSON κ³Ό Protobuf λ‘ λ‹¤ μ§€μ›ν•λ”μ§€ μ—¬λ¶€

## β΅ **μ£Όμμ **

κµ¬ν„ λ‚΄μ© μ¤‘μ— μ–΄λ λ¶€λ¶„μ΄ λλ“  I/O multiplexing κ³Ό proder-consumer λ¬Έμ λ¥Ό κµ¬ν„ν•λ©΄ λ©λ‹λ‹¤.

κ·Έλ°λ° κµ¬ν„ ν•΄μ•Όλλ” λ‚΄μ©μ΄ λ„λ¬΄ λ»”ν•΄μ„ μ•„λ§λ„ I/O multiplexing μ€ μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈ μ†μΌ“κ³Ό μƒλ΅μ΄ μ—°κ²°μ„ μ²λ¦¬ν•λ”λ° μ¨μ•Όλ  κ²ƒ μ΄κ³ , producer-consumer λ¬Έμ λ” κ° ν΄λΌμ΄μ–ΈνΈμ—μ„ λ³΄λ‚΄μ¨ λ©”μ‹μ§€λ¥Ό μ²λ¦¬ν•λ” ν•νƒκ°€ λ  κ²ƒμ…λ‹λ‹¤.

μ΄ λ• producer-consumer μ queue μ— κ° ν΄λΌμ΄μ–ΈνΈμ λ©”μ‹μ§€λ¥Ό μ§‘μ–΄ λ„£λ” κ²½μ°λ” μ£Όμκ°€ ν•„μ”ν•©λ‹λ‹¤. μΌλ°μ μΈ κ²½μ°μ—μ„λ” κ²½ν—ν•κΈ° μ–΄λ µμ§€λ§, λ©”μ‹μ§€κ°€ λ§¤μ° λΉ λ¥Έ μ†λ„λ΅ λ“¤μ–΄μ¤λ” κ²½μ° ν• ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° μ¨ λ©”μ‹μ§€κ°€ 2κ° μ΄μƒ queue μ— λ“¤μ–΄κ° μ μκ² κµ¬ν„ ν•  κ²½μ°, μ΄ λ‘ λ©”μ‹μ§€κ°€ μ„λ΅ λ‹¤λ¥Έ μ“°λ λ“μ— μν•΄ μ²λ¦¬ λλ‹¤λ©΄ λ©”μ‹μ§€μ μ²λ¦¬ μμ„κ°€ μ–΄κΈ‹λ‚λ” λ¬Έμ κ°€ μƒκΈΈ μ μμµλ‹λ‹¤.

- μ) client A κ°€ λ§¤μ° λΉ λ¥΄κ² λ©”μ‹μ§€1, 2 λ‘κ°λ¥Ό μ „μ†΅ν–λ”λ°, λ‘μ„ νμ— λ„£λ” κ²½μ° μ“°λ λ“1λ²μ€ λ©”μ‹μ§€1 μ„ μ“°λ λ“2λ²μ€ λ©”μ‹μ§€2λ¥Ό μ²λ¦¬ν•κ² λ  μ μμµλ‹λ‹¤. μ΄ κ²½μ° μ²λ¦¬ μμ„κ°€ λ©”μ‹μ§€1 -> λ©”μ‹μ§€2 μ—¬μ•Ό ν•¨μ—λ„ μ“°λ λ“μ— μν• race condition μ΄ λ°μƒν•  μ μμµλ‹λ‹¤.

λ”°λΌμ„ μ΄ κ²½μ°λ” λ©”μ‹μ§€λ“¤μ„ κ°κ° νμ— λ„£μ–΄μ„λ” μ•λκ³ , ν΄λΌμ΄μ–ΈνΈ μμ²΄λ¥Ό νμ— λ„£κ±°λ‚, μ•„λ‹λ©΄ μ΄λ―Έ ν•΄λ‹Ή ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° λ°›μ€ λ©”μ‹μ§€κ°€ νμ— μλ” κ²½μ° κΈ°μ΅΄ λ©”μ‹μ§€λ¥Ό μ²λ¦¬ ν• λ’¤μ— λ‹¤μ‹ νμ— λ„£λ” λ°©μ‹μΌλ΅ κµ¬ν„ν•΄μ•Ό λ©λ‹λ‹¤.